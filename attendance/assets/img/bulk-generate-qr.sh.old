#!/usr/bin/env bash

# ===============================
# Configuración
# ===============================
BASE_URL="https://castelancarpinteyro.com/php-scripts/create-qr.php"
QR_PUBLIC_PATH="https://castelancarpinteyro.com/php-scripts/generated-qrs"
OUTPUT_DIR="./qrs"

# ===============================
# Validaciones
# ===============================
if [[ -z "$1" ]]; then
  echo "Uso: $0 lista_de_urls.txt"
  exit 1
fi

if [[ ! -f "$1" ]]; then
  echo "El archivo '$1' no existe"
  exit 1
fi

mkdir -p "$OUTPUT_DIR"

# ===============================
# Procesamiento
# ===============================
while IFS= read -r url || [[ -n "$url" ]]; do

  # Saltar líneas vacías o comentarios
  [[ -z "$url" || "$url" =~ ^# ]] && continue

  echo "Generando QR para: $url"

  # Llamar al endpoint y capturar la redirección
  LOCATION=$(curl -s -I -G --data-urlencode "url=$url" "$BASE_URL" \
    | grep -i "^location:" \
    | awk '{print $2}' \
    | tr -d '\r')

  if [[ -z "$LOCATION" ]]; then
    echo "  Error: no se obtuvo redirección"
    continue
  fi

  # Extraer nombre del archivo
  FILE=$(basename "$LOCATION")

  # Descargar el QR
  curl -s "$QR_PUBLIC_PATH/$FILE" -o "$OUTPUT_DIR/$FILE"

  if [[ $? -eq 0 ]]; then
    echo "  Guardado como: $OUTPUT_DIR/$FILE"
  else
    echo "  Error al descargar $FILE"
  fi

done < "$1"

echo "Proceso finalizado."
